# -*- coding: utf-8 -*-
"""app.py

Automatically generated by Colab.

Original file is located at
    https://colab.research.google.com/drive/1LHqKXcI0a_GUY8s22kDHTlS_pFyIOA5A
"""
import streamlit as st
import requests
from PIL import Image
from PyPDF2 import PdfReader

# ---------------- CONFIG ---------------- #

HF_API_KEY = st.secrets["HF_API_KEY"]

# Stable working caption model
IMAGE_MODEL_URL = "https://api-inference.huggingface.co/models/nlpconnect/vit-gpt2-image-captioning"

headers = {
    "Authorization": f"Bearer {HF_API_KEY}"
}

# ---------------- IMAGE CAPTION FUNCTION ---------------- #

def describe_image(image_bytes):
    response = requests.post(
        IMAGE_MODEL_URL,
        headers=headers,
        data=image_bytes
    )

    if response.status_code == 503:
        return "Model is loading. Wait 30â€“60 seconds and try again."

    if response.status_code != 200:
        return f"API Error: {response.status_code}"

    try:
        result = response.json()
        if isinstance(result, list) and "generated_text" in result[0]:
            return result[0]["generated_text"]
        return str(result)
    except:
        return "Invalid API response"


# ---------------- STREAMLIT UI ---------------- #

st.title("ðŸ–¼ Image + ðŸ“„ PDF Assistant")

uploaded_file = st.file_uploader(
    "Upload Image or PDF",
    type=["png", "jpg", "jpeg", "pdf"]
)

pdf_text = ""

if uploaded_file:

    # -------- IMAGE -------- #
    if uploaded_file.type in ["image/png", "image/jpeg"]:

        image = Image.open(uploaded_file)
        st.image(image, use_column_width=True)

        with st.spinner("Analyzing image..."):
            image_bytes = uploaded_file.read()
            description = describe_image(image_bytes)

        st.success("Image Description:")
        st.write(description)

    # -------- PDF -------- #
    elif uploaded_file.type == "application/pdf":

        reader = PdfReader(uploaded_file)
        text = ""

        for page in reader.pages:
            page_text = page.extract_text()
            if page_text:
                text += page_text

        if text.strip():
            pdf_text = text
            st.success("PDF Text Extracted Successfully")
            st.write(text[:1000])  # preview first 1000 characters
        else:
            st.error("No readable text found in PDF.")

# -------- PDF Q&A -------- #

if pdf_text:
    question = st.text_input("Ask something about the PDF")

    if question:
        if question.lower() in pdf_text.lower():
            st.success("Answer found in PDF text.")
        else:
            st.warning("Exact answer not found. Try rephrasing.")
